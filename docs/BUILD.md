# Build & Distribution Guide

## UI Version Selection (NEW)

**PFR Sentinel now supports building with either the new PySide6 UI or legacy Tkinter UI.**

### Build New UI (Default - PySide6)
```batch
build_sentinel.bat
# or
build_sentinel_installer.bat
```
- Modern Windows 11 Fluent design
- Better performance and animations
- Entry point: `main_pyside.py`
- Spec file: `PFRSentinel_PySide.spec`

### Build Old UI (Legacy - Tkinter)
```batch
build_sentinel.bat --legacy
# or
build_sentinel_installer.bat --legacy
```
- Proven stable interface
- Entry point: `main.py`
- Spec file: `PFRSentinel.spec`

**Note**: Both UIs share the same backend (`services/`) and produce the same `PFRSentinel.exe` filename. The UI framework is bundled internally. Both support all command-line flags (`--headless`, `--tray`, `--auto-start`, `--auto-stop`).

---

## Overview

This document describes how to build ASIOverlayWatchDog as a Windows executable and create an installer.

## Prerequisites

### 1. Python Environment
- Python 3.7+ with virtual environment activated
- All dependencies installed (`pip install -r requirements.txt`)
- PyInstaller installed (`pip install pyinstaller`)

**IMPORTANT**: Always build from within the virtual environment!

```batch
# Activate venv first
.\venv\Scripts\Activate.ps1

# Verify dependencies are installed
pip install -r requirements.txt
pip install pyinstaller
```

### 2. Inno Setup (for installer only)
- Download from: https://jrsoftware.org/isinfo.php
- Install to default location: `C:\Program Files (x86)\Inno Setup 6\`
- Or: `C:\Program Files\Inno Setup 6\`

### 3. Required Files
- `ASICamera2.dll` - ZWO ASI SDK library (must be in project root)
- `app_icon.ico` - Application icon (auto-generated by `create_icon.py`)

## Application Icon

The application uses a custom astronomy-themed icon showing a ZWO camera with stars.

### Regenerate Icon (if needed)
```batch
python create_icon.py
```

This creates:
- `app_icon.ico` - Multi-resolution Windows icon (16x16 to 256x256)
- `app_icon.png` - Reference PNG image

The icon is automatically included in:
- Window title bar (via `iconbitmap()`)
- Executable file (via PyInstaller spec)
- Installer setup wizard (via Inno Setup)

## Quick Build

### Build Executable Only
```batch
build_exe.bat
```

**Output**: `dist\ASIOverlayWatchDog\ASIOverlayWatchDog.exe`

### Build Executable + Installer
```batch
build_installer.bat
```

**Output**: `installer\dist\ASIOverlayWatchDog-2.0.0-setup.exe`

## Manual Build Steps

### Step 1: Build Executable

```batch
# Activate virtual environment
venv\Scripts\activate.bat

# Clean previous builds
rmdir /s /q build
rmdir /s /q dist\ASIOverlayWatchDog

# Build with PyInstaller
pyinstaller ASIOverlayWatchDog.spec
```

### Step 2: Test Executable

```batch
# Run the built executable
dist\ASIOverlayWatchDog\ASIOverlayWatchDog.exe
```

Verify:
- Application launches without console window
- ZWO camera detection works (if camera connected)
- Directory watch mode works
- Overlays render correctly
- Settings persist
- Logs tab shows messages
- Preview tab displays images

### Step 3: Create Installer

```batch
# Build installer with Inno Setup
"C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\ASIOverlayWatchDog.iss
```

**Output**: `installer\dist\ASIOverlayWatchDog-2.0.0-setup.exe`

### Step 4: Test Installer

1. **Fresh Install**:
   - Run `ASIOverlayWatchDog-2.0.0-setup.exe`
   - Choose installation directory (default: `C:\Program Files\ASIOverlayWatchDog`)
   - Optionally create desktop shortcut
   - Complete installation
   - Launch from Start Menu

2. **Verify Installation**:
   - Application runs from Start Menu
   - Desktop shortcut works (if created)
   - Logs appear in `%LOCALAPPDATA%\ASIOverlayWatchDog\Logs\`

3. **Test Upgrade**:
   - Build new version (update `version.py`)
   - Run new installer
   - Verify old version is uninstalled first
   - Verify logs and config are preserved

4. **Test Uninstall**:
   - Uninstall via Control Panel or Start Menu
   - Verify Program Files directory removed
   - Verify Start Menu shortcuts removed
   - Verify logs remain in `%LOCALAPPDATA%\ASIOverlayWatchDog\Logs\`

## Versioning

### Update Version for New Release

1. Edit `version.py` (single source of truth):
   ```python
   __version__ = "2.1.0"  # Update this line
   ```

2. Run build script (automatically syncs version to installer):
   ```batch
   build_installer.bat
   ```

   The build script will:
   - Run `update_version.py` to generate `version.iss` from `version.py`
   - Build the executable with PyInstaller
   - Compile the installer with Inno Setup (includes auto-generated `version.iss`)

**Note**: `version.iss` is auto-generated and excluded from git (.gitignore)

## File Locations After Installation

### Application Files
- **Installed to**: `C:\Program Files\ASIOverlayWatchDog\`
- **Executable**: `ASIOverlayWatchDog.exe`
- **Bundled DLL**: `ASICamera2.dll`
- **Python runtime**: `*.pyd`, `*.dll`, `python*.dll`
- **Libraries**: `_internal\` folder

### User Data (NOT removed on uninstall)
- **Logs**: `%LOCALAPPDATA%\ASIOverlayWatchDog\Logs\`
  - `watchdog.log` - Current log file
  - `watchdog.log.YYYY-MM-DD` - Rotated logs (7 days kept)
  - Automatic daily rotation
  - Automatic cleanup of logs older than 7 days

- **Config**: `config.json` (in application directory for now)
  - **Note**: Could be moved to `%LOCALAPPDATA%\ASIOverlayWatchDog\` in future

## Logging System

### Log Behavior
- **Location**: `%LOCALAPPDATA%\ASIOverlayWatchDog\Logs\watchdog.log`
- **Rotation**: Daily at midnight
- **Retention**: Last 7 days only
- **Cleanup**: Automatic on app startup and via TimedRotatingFileHandler
- **Format**: 
  - Console: `[HH:MM:SS] LEVEL: message`
  - File: `[YYYY-MM-DD HH:MM:SS] LEVEL [module:function:line] message`

### Log Levels
- **DEBUG**: Verbose diagnostic info (file only)
- **INFO**: Normal operations (console + file)
- **WARNING**: Warnings (console + file)
- **ERROR**: Errors (console + file)

### Example Log Path
On a typical Windows system for user "John":
```
C:\Users\John\AppData\Local\ASIOverlayWatchDog\Logs\watchdog.log
```

## Distribution

### For Users
1. Provide the installer: `ASIOverlayWatchDog-2.0.0-setup.exe`
2. Include installation instructions:
   - Double-click installer
   - Follow prompts
   - Launch from Start Menu
   - Logs automatically managed in background

### For Developers
1. Provide source code
2. Include this build guide
3. Ensure `ASICamera2.dll` is available
4. Document any system-specific dependencies

## Troubleshooting

### Build Fails - "ModuleNotFoundError: No module named 'ttkbootstrap'"

**Cause**: Building from system Python instead of virtual environment.

**Solution**:
```batch
# ALWAYS activate venv before building
.\venv\Scripts\Activate.ps1

# Verify ttkbootstrap is installed
pip show ttkbootstrap

# If not installed:
pip install -r requirements.txt

# Then rebuild
pyinstaller --clean ASIOverlayWatchDog.spec
```

The build scripts (`build_exe.bat` and `build_installer.bat`) automatically activate the venv, so use those instead of running PyInstaller directly.

### Build Fails - Missing Dependencies
```batch
pip install -r requirements.txt
pip install pyinstaller
```

### Build Fails - ASICamera2.dll Not Found
- Ensure `ASICamera2.dll` is in project root
- Download from ZWO website: https://astronomy-imaging-camera.com/software-drivers

### Installer Fails - Inno Setup Not Found
- Install Inno Setup 6.0+
- Or update `build_installer.bat` with correct path

### Executable Won't Run
- Test in `dist\ASIOverlayWatchDog\` first
- Check for missing DLL errors
- Run from command line to see error messages:
  ```batch
  dist\ASIOverlayWatchDog\ASIOverlayWatchDog.exe
  ```

### Logs Not Appearing
- Check `%LOCALAPPDATA%\ASIOverlayWatchDog\Logs\`
- Verify write permissions
- Check console output for logging initialization errors

## PyInstaller Spec File Details

### Key Settings
- **Mode**: `onedir` (directory with exe + dependencies)
- **Console**: `False` (windowed application)
- **UPX**: `True` (compression enabled)
- **Bundled Files**:
  - `ASICamera2.dll` - ZWO SDK
  - `version.py` - Version info
  - ttkbootstrap data files (themes)

### Customization
Edit `ASIOverlayWatchDog.spec` to:
- Add icon: `icon='path/to/icon.ico'`
- Include additional data files
- Adjust hidden imports
- Change compression settings

## Release Checklist

- [ ] Update `version.py` with new version number
- [ ] **Disable dev mode** in `services\dev_mode_config.py` (set `DEV_MODE_AVAILABLE = False`)
- [ ] Update `installer\ASIOverlayWatchDog.iss` version
- [ ] Test application from source (`python main.py`)
- [ ] Build executable (`build_exe.bat`)
- [ ] Test executable (`dist\ASIOverlayWatchDog\ASIOverlayWatchDog.exe`)
- [ ] **Verify dev mode disabled** (no raw_debug files created, no Developer Mode UI section)
- [ ] Build installer (`build_installer.bat`)
- [ ] **Upload to VirusTotal** (`python scripts\upload_to_virustotal.py`) - [See guide](VIRUSTOTAL_SCANNING.md)
- [ ] Test fresh install on clean system
- [ ] Test upgrade from previous version
- [ ] Verify logs rotation working
- [ ] Verify uninstall doesn't remove logs
- [ ] Create release notes (include VirusTotal scan link)
- [ ] Tag git commit with version number
- [ ] Upload installer to distribution location
- [ ] **Re-enable dev mode** in `services\dev_mode_config.py` for continued development

## File Size Expectations

- **Executable Build**: ~200-300 MB (includes Python runtime + dependencies)
- **Installer**: ~100-150 MB (compressed)
- **Installed Size**: ~300-400 MB

## Performance

- **Startup Time**: 2-5 seconds (onedir build)
- **Memory Usage**: ~100-200 MB typical
- **Log File Size**: ~1-5 MB per day (depends on activity)
